\chapter{Phân tích yêu cầu hệ thống}
\section{Yêu cầu chức năng}
\subsection{Người dùng}
\begin{itemize}
    \item Có thể theo dõi các thông số quan trọng của quá trình vận chuyển theo thời gian thực trên ứng dụng và web, bao gồm độ rung, nhiệt độ, vị trí GPS và thời gian cập nhật.
    \item Có thể xem vị trí hiện tại và toàn bộ lộ trình của phương tiện trên bản đồ, đồng thời cập nhật tuyến đường khi cần thiết.
    \item Có thể nhận cảnh báo ngay lập tức qua ứng dụng hoặc web khi hệ thống phát hiện nhiệt độ hoặc độ rung vượt ngưỡng cho phép hoặc khi phương tiện đi lệch lộ trình.
    \item Có thể giám sát trạng thái vận chuyển và tiến độ của chuyến hàng.
    \item Có thể xem và truy xuất lịch sử của các thông số vận chuyển và các sự kiện cảnh báo đã xảy ra.
    \item Có thể quản lý quyền truy cập và phân quyền cho các vai trò khác nhau như quản trị viên, điều phối viên, lái xe và kỹ thuật viên.
    \item Quản trị viên có thể xem nhật ký đăng nhập và thao tác của tất cả người dùng trong hệ thống.
\end{itemize}

\subsection{Hệ thống}
\begin{itemize}
    \item Phải liên tục thu thập và xử lý dữ liệu từ các cảm biến độ rung, nhiệt độ và thiết bị GPS.
    \item Phải đồng bộ hóa các dữ liệu này lên hệ thống trung tâm và hiển thị theo thời gian thực trên giao diện người dùng.
    \item Phải phân tích dữ liệu để đề xuất lộ trình tối ưu dựa trên các thông số đã thu được.
    \item Phải tự động xác định và kích hoạt cảnh báo khi các thông số vượt ngưỡng hoặc khi vị trí phương tiện đi chệch khỏi lộ trình đã định.
    \item Phải gửi thông báo cảnh báo đến trung tâm điều hành và người có thẩm quyền qua ứng dụng hoặc web.
    \item Phải lưu trữ và quản lý toàn bộ lịch sử vận chuyển và dữ liệu liên quan một cách an toàn.
    \item Phải thực hiện xác thực người dùng trước khi cấp quyền truy cập hệ thống.
    \item Phải thực hiện xác thực thiết bị trước khi chấp nhận dữ liệu gửi về.
    \item Phải mã hóa dữ liệu trong quá trình truyền tải và khi lưu trữ để đảm bảo bảo mật dữ liệu.
\end{itemize}
\section{Yêu cầu phi chức năng}
\subsection{Hiệu năng}
\begin{itemize}
    \item Hệ thống phải đảm bảo truyền dữ liệu từ thiết bị đến máy chủ trong khoảng 2-3 giây.
    \item Dữ liệu mới phải được cập nhật lên giao diện người dùng trong vòng dưới 5 giây kể từ khi dữ liệu được gửi về.
\end{itemize}

\subsection{Tính sẵn sàng}
\begin{itemize}
    \item Hệ thống phải đảm bảo sẵn sàng hoạt động trên 90\% khi có kết nối mạng ổn định.
    \item Dữ liệu phải được thu thập và lưu trữ liên tục khi hệ thống hoạt động.
\end{itemize}

\subsection{Khả năng mở rộng}
\begin{itemize}
    \item Hệ thống phải hỗ trợ cùng lúc nhiều thiết bị, với mức tối thiểu là 4 thiết bị đang hoạt động đồng thời.
    \item Thiết kế hệ thống phải cho phép tích hợp thêm các loại cảm biến mới khác nếu có nhu cầu giám sát mở rộng.
\end{itemize}

\subsection{Tính dễ sử dụng}
\begin{itemize}
    \item Giao diện người dùng phải trực quan, dễ nhìn và dễ thao tác.
    \item Người dùng mới có thể làm quen với các chức năng chính của hệ thống trong không quá 15 phút.
\end{itemize}

\subsection{Tính tương thích}
\begin{itemize}
    \item Hệ thống phải tương thích với các thiết bị IoT phổ biến trên thị trường.
    \item Ứng dụng di động phải hỗ trợ tốt trên nền tảng Android.
\end{itemize}

\subsection{Khả năng bảo trì}
\begin{itemize}
    \item Hệ thống phải được thiết kế theo hướng module hóa để cho phép bảo trì hoặc nâng cấp từng phần mà không làm ảnh hưởng đến toàn bộ hoạt động.
    \item Phải cung cấp đầy đủ tài liệu kỹ thuật và hướng dẫn sử dụng.
\end{itemize}
\section{Quy trình vận chuyển đạn dược}
Quy trình vận chuyển đạn dược được tổ chức theo một chuỗi bước nghiêm ngặt nhằm đảm bảo an toàn tuyệt đối cho phương tiện, hàng hóa và nhân sự. Hệ thống IoT đóng vai trò hỗ trợ giám sát toàn bộ quá trình, kết hợp với các quy định truyền thống của công tác vận chuyển quân sự để nâng cao mức độ an toàn và khả năng ứng phó sự cố.

Trước khi xuất phát, phương tiện và lô đạn dược được kiểm tra toàn diện về tình trạng kỹ thuật, bao gói, niêm phong và khối lượng theo đúng tiêu chuẩn an toàn. Các cảm biến IoT như nhiệt độ, độ rung và GPS được kích hoạt, kiểm tra tín hiệu và xác thực kết nối với hệ thống trung tâm. Điều phối viên tiến hành cấu hình tuyến đường, thông số giám sát và thiết lập vùng địa lý cho chuyến đi.

Tại điểm xuất phát, đạn được xếp lên phương tiện theo đúng quy định về an toàn và trọng tải. Sau khi hoàn tất, lực lượng phụ trách thực hiện các bước xác nhận bàn giao cần thiết cho tài xế và ghi nhận thông tin vào hệ thống trước khi khởi hành. 

Khi phương tiện bắt đầu di chuyển, thiết bị IoT trên xe sẽ gửi dữ liệu định kỳ về hệ thống trung tâm, bao gồm vị trí GPS, tốc độ, nhiệt độ và độ rung. Hệ thống dựa trên các dữ liệu này để tự động cập nhật trạng thái chuyến đi và hiển thị lộ trình theo thời gian thực, giúp điều phối viên theo dõi và nắm bắt tình hình liên tục.

Trong suốt hành trình, hệ thống IoT có nhiệm vụ giám sát và phát hiện các điều kiện bất thường như nhiệt độ vượt ngưỡng, rung/lắc mạnh, lệch khỏi tuyến đường quy định, dừng quá lâu ngoài khu vực cho phép hoặc mất kết nối truyền thông. Khi xảy ra sự cố, hệ thống sẽ phát cảnh báo ngay lập tức để điều phối viên kịp thời chỉ đạo, có thể yêu cầu dừng kiểm tra, điều chỉnh hướng di chuyển hoặc huy động lực lượng hỗ trợ gần nhất.

Khi xe đến điểm nhận, tài xế và lực lượng tại kho đích tiến hành kiểm tra niêm phong, xác nhận bàn giao và hoàn tất các thủ tục theo quy định. Thông tin về thời gian, vị trí và nhân sự tiếp nhận được hệ thống ghi nhận đầy đủ.

Sau khi bàn giao hoàn tất, toàn bộ dữ liệu liên quan đến chuyến vận chuyển như lộ trình thực tế, thông số giám sát, cảnh báo và các bước xử lý được lưu trữ trên hệ thống. Các dữ liệu này phục vụ công tác đánh giá rủi ro, truy vết và tối ưu hóa các nhiệm vụ vận chuyển trong tương lai.

\section{Các rủi ro cần giám sát}
Trong quá trình vận chuyển đạn dược, tồn tại nhiều rủi ro tiềm ẩn có thể ảnh hưởng trực tiếp đến an toàn con người, phương tiện và hàng hoá. Để giảm thiểu những nguy cơ này, hệ thống IoT được triển khai nhằm giám sát liên tục, phát hiện sớm bất thường và hỗ trợ điều phối xử lý kịp thời. 

Một trong những rủi ro quan trọng là nhiệt độ, bởi đạn dược rất nhạy cảm với môi trường nóng, vì khi xe di chuyển qua khu vực nhiệt độ cao hoặc dừng lâu dưới trời nắng, nhiệt độ bên trong thùng chứa có thể vượt quá ngưỡng an toàn, đòi hỏi hệ thống phải cảnh báo ngay lập tức. 

Bên cạnh đó, rung và lắc mạnh do đường xấu, phanh gấp hoặc va chạm cũng là yếu tố nguy hiểm, có thể ảnh hưởng đến độ ổn định của đạn, cảm biến rung giúp phát hiện các xung lực bất thường và gửi cảnh báo cho điều phối viên. 

Hệ thống cũng cần phát hiện lệch lộ trình, bởi việc phương tiện đi sai đường có thể dẫn đến nguy cơ an ninh, xâm nhập khu vực cấm hoặc rơi vào tình huống bị theo dõi. Ngoài ra, dừng hoặc bất động bất thường là dấu hiệu của sự cố hoặc can thiệp trái phép, vì vậy dữ liệu thời gian dừng được phân tích để đánh giá mức độ nguy hiểm.

Một rủi ro khác là mất tín hiệu hoặc mất kết nối truyền thông, khiến thiết bị không thể gửi dữ liệu về trung tâm, khi đó, hệ thống phải ghi nhớ dữ liệu và đồng bộ lại khi kết nối được phục hồi. Vấn đề an ninh thiết bị cũng đặc biệt quan trọng, bởi thiết bị IoT có thể bị truy cập trái phép hoặc gửi dữ liệu giả mạo nếu thiếu cơ chế bảo vệ, do đó cần áp dụng mã hóa, ký số và xác thực hai chiều.

Bên cạnh các yếu tố kỹ thuật, hệ thống còn phải tính đến sự cố phương tiện, chẳng hạn như hỏng động cơ, thủng lốp hoặc tai nạn, thường thể hiện qua các tín hiệu rung bất thường, dừng đột ngột hoặc mất tín hiệu. Nguy hiểm nhất là rủi ro cháy nổ, có thể xảy ra khi nhiệt độ tăng nhanh, va chạm mạnh hoặc rò rỉ nhiên liệu; do vậy các cảm biến phải giám sát chặt chẽ để đưa ra cảnh báo sớm.


\section{Use-case diagram}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\linewidth]{images/chapter_3/usecase.png}
    \caption{Usecase diagram}
    \label{fig:placeholder}
\end{figure}
\textbf{Đặc tả diagram}

\section{Activity diagram}
\subsection{Điều phối lộ trình}
Sơ đồ hoạt động này minh hoạ các khối chức năng của hệ thống, bao gồm ba phần: \textbf{Người dùng (Điều phối viên)}, \textbf{Hệ thống điều phối}, và \textbf{Thiết bị/Phương tiện}.

\textbf{Người dùng}
\begin{itemize}
  \item Khởi tạo yêu cầu điều phối và nhập ràng buộc: điểm nhận/giao, cửa sổ thời gian, năng lực phương tiện, vùng cấm (geofence), yêu cầu an toàn.
  \item Duyệt phương án hệ thống đề xuất (KPI/ETA hiển thị trên bản đồ) và phê duyệt (Approve) hoặc quay lại chỉnh ràng buộc nếu chưa phù hợp.
\end{itemize}

\textbf{Hệ thống điều phối}
\begin{itemize}
  \item Kiểm tra hợp lệ dữ liệu đầu vào (đủ trường, không trùng, đúng geofence \& time window).
  \item Xây dựng đồ thị lộ trình và chạy thuật toán tối ưu (VRP/TSP mở rộng) để tạo kế hoạch lộ trình kèm KPI/ETA.
  \item Đóng gói payload (các chặng, toạ độ, ETA, geofence, tham số cảnh báo) và phát hành qua broker.
  \item Theo dõi ACK từ thiết bị; nếu không nhận ACK thì xếp hàng/Retry theo backoff cho lần gửi tiếp theo.
\end{itemize}

\textbf{Thiết bị/Phương tiện}
\begin{itemize}
  \item Nhận lộ trình, gửi ACK xác nhận và bắt đầu hành trình theo kế hoạch đã phát hành.
\end{itemize}

\textbf{Kết quả:} Kế hoạch lộ trình được tối ưu, phê duyệt và phát hành xuống thiết bị; trạng thái phát hành được theo dõi qua ACK/Retry để đảm bảo thực thi.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/activity_điều phối.png}
  \caption{Activity diagram: Điều phối lộ trình}
  \label{fig:act-dieu-phoi}
\end{figure}

% -------------------------------------------------------------

\subsection{Quản lý hàng hoá}
Sơ đồ hoạt động này minh hoạ vòng đời bản ghi hàng hoá/đơn vận chuyển: đăng ký, cập nhật, bàn giao và theo dõi trạng thái. Quá trình gồm Người dùng (Kho/Điều phối), Hệ thống quản lý và Điểm giao nhận/Thiết bị quét.

\textbf{Người dùng}
\begin{itemize}
  \item \textbf{Đăng ký (Add):} nhập thông tin lô/đơn (loại, khối lượng, bao gói, đơn vị nhận, ưu tiên).
  \item \textbf{Cập nhật (Update):} quét/nhập \texttt{ID} để chỉnh thuộc tính.
  \item \textbf{Tra cứu \& đổi trạng thái (Track):} theo tiến trình \texttt{READY} $\rightarrow$ \texttt{LOADED} $\rightarrow$ \texttt{IN\_TRANSIT} $\rightarrow$ \texttt{DELIVERED/RETURNED}.
  \item Tại các điểm Load/Unload/Deliver: quét ID để ghi nhận bàn giao.
\end{itemize}

\textbf{Hệ thống quản lý}
\begin{itemize}
  \item Xác thực dữ liệu khi tạo mới; nếu trùng ID trả lỗi và yêu cầu nhập lại; nếu hợp lệ thì cấp/ghi ID (QR/RFID) và lưu CSDL.
  \item Với Update/Track: kiểm tra tồn tại; nếu có, cho phép chỉnh sửa/đổi trạng thái và ghi audit log.
  \item Với sự kiện bàn giao: đối chiếu đơn--phương tiện, ghi sự kiện (thời gian, vị trí, người phụ trách) và đồng bộ trạng thái lên dashboard/app.
\end{itemize}

\textbf{Điểm giao nhận/Thiết bị quét}
\begin{itemize}
  \item Quét \& gửi đối soát (OK/Rejected). Trường hợp không khớp, hệ thống từ chối và yêu cầu kiểm tra lại trước khi cập nhật.
\end{itemize}

\textbf{Kết quả:} Hàng hoá được đăng ký -- truy vết -- bàn giao đúng quy trình; audit log đầy đủ; trạng thái đồng bộ giữa kho, phương tiện và dashboard.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/activity_quản lý.png}
  \caption{Activity diagram: Quản lý hàng hoá}
  \label{fig:act-hang-hoa}
\end{figure}

% -------------------------------------------------------------

\subsection{Giám sát \& cập nhật trạng thái vận chuyển }
Sơ đồ hoạt động này minh hoạ pipeline thu thập -- xác thực -- lưu trữ telemetry (GPS, tốc độ, nhiệt, rung), phát hiện bất thường và cập nhật trạng thái chuyến. Quá trình gồm \textbf{Thiết bị}, \textbf{Hệ thống giám sát} và \textbf{Người dùng (Giám sát viên/Điều phối)}.

\textbf{Thiết bị}
\begin{itemize}
  \item Định kỳ gửi gói dữ liệu. Nếu Online gửi trực tiếp; nếu Offline thì đệm cục bộ và gửi lại khi có kết nối.
\end{itemize}

\textbf{Hệ thống giám sát}
\begin{itemize}
  \item Nhận gói tin và xác thực (verify): định danh, bảo mật/chữ ký, cấu trúc dữ liệu.
  \item Nếu không đạt, ghi lỗi và không cập nhật; nếu đạt, lưu dữ liệu và cập nhật trạng thái chuyến (\texttt{IN\_TRANSIT}/\texttt{DELAYED}/\texttt{ALERT}/\texttt{ARRIVED}/\texttt{DELIVERED}).
  \item Đánh giá luật bất thường: vượt ngưỡng an toàn (nhiệt/rung), lệch lộ trình (geofence), dừng bất thường/over-speed. Khi phát hiện ALERT, tạo cảnh báo, có thể mở sự cố và đề xuất hành động; nếu đến đích, xác nhận bàn giao và đóng chuyến.
\end{itemize}

\textbf{Người dùng}
\begin{itemize}
  \item Nhận thông báo, xử lý cảnh báo (ack/assign/resolve), và khi cần có thể bổ sung ghi chú để hoàn tất hồ sơ sự cố.
\end{itemize}

\textbf{Kết quả:} Trạng thái vận chuyển được cập nhật liên tục; bất thường được phát hiện sớm \& cảnh báo; dữ liệu được xác thực -- lưu trữ an toàn và liên thông với điều phối để tái tối ưu khi cần.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/activity_giám sát.png}
  \caption{Activity diagram: Giám sát \& cập nhật trạng thái vận chuyển}
  \label{fig:act-giam-sat}
\end{figure}

\section{Sequence diagram}
Phần này trình bày ba sơ đồ trình tự tương ứng với ba khối chức năng cốt lõi của hệ thống: \textbf{Điều phối lộ trình}, \textbf{Quản lý hàng hoá} và \textbf{Giám sát \& cập nhật trạng thái vận chuyển}. Mỗi sơ đồ mô tả chi tiết chuỗi tương tác theo thời gian giữa ba thành phần chính: \emph{Dashboard} (giao diện người dùng), \emph{Hệ thống} (xử lý nghiệp vụ) và \emph{Thiết bị} (thiết bị/ứng dụng triển khai tại hiện trường). Thông qua các sơ đồ này, quá trình xử lý tác vụ, phản hồi và đồng bộ dữ liệu giữa các thành phần được biểu diễn một cách rõ ràng, hỗ trợ cho việc thiết kế, hiện thực và đánh giá hệ thống.

\subsection{Điều phối lộ trình}

Trong chức năng điều phối lộ trình, Dashboard đóng vai trò khởi tạo yêu cầu điều phối bao gồm tập đơn hàng, các ràng buộc vận hành, khoảng thời gian giao (\emph{time windows}) và các khu vực hạn chế. Hệ thống tiếp nhận yêu cầu, kiểm tra tính hợp lệ, tải dữ liệu đội xe, kho và đơn hàng, đồng thời xây dựng ma trận chi phí hoặc thời gian. Dựa trên các dữ liệu này, hệ thống giải bài toán tối ưu (VRP/VRPTW) để sinh ra kế hoạch lộ trình cùng các chỉ số đánh giá (KPI), sau đó gửi kết quả về Dashboard để người vận hành xem trước.

Quá trình xử lý phân nhánh thành hai hướng chính. Trường hợp kế hoạch được phê duyệt, hệ thống tiến hành công bố lộ trình và chuyển danh sách điểm dừng, thời gian dự kiến (ETA) đến Thiết bị, đồng thời tạo \emph{geofence} và các điểm kiểm soát dọc tuyến. Ngược lại, nếu người vận hành thực hiện chỉnh sửa, Dashboard gửi lại ràng buộc cập nhật, hệ thống chạy lại thuật toán tối ưu và trả về kế hoạch mới kèm theo so sánh KPI giữa hai phiên bản.

Khi vận hành thực tế diễn ra, Hệ thống và Thiết bị hoạt động song song. Thiết bị gửi dữ liệu \emph{telemetry} định kỳ để hệ thống ghi lại lịch sử, cập nhật tiến độ và tính toán ETA theo thời gian thực, sau đó hiển thị trên Dashboard. Đồng thời, hệ thống liên tục đánh giá điều kiện giao thông và phát hiện lệch tuyến để đưa ra gợi ý điều hướng lại khi cần thiết.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/sequence_điều phối lộ trình.png}
  \caption{Sequence diagram: Điều phối lộ trình}
  \label{fig:sd-dieu-phoi}
\end{figure}

\subsection{Quản lý hàng hoá}

Trong chức năng quản lý hàng hoá, Dashboard khởi tạo lô/kiện với các thông tin mô tả như danh sách vật phẩm, trọng lượng, hoặc điều kiện bảo quản yêu cầu. Hệ thống tiếp nhận yêu cầu, sinh mã định danh (QR/Tag) cho từng lô/kiện và lưu lại các ràng buộc như mức nhiệt độ cho phép hay ngưỡng rung, sau đó trả mã về để gắn hoặc in nhãn. Khi phân bổ hàng hóa, Dashboard gán các lô/kiện cho phương tiện hoặc thiết bị, và hệ thống cập nhật ánh xạ giữa lô hàng, phương tiện và thiết bị giám sát tương ứng.

Trong quá trình đối soát, thiết bị gửi sự kiện liên quan đến niêm phong hoặc phát hiện can thiệp trái phép. Hệ thống ghi nhận trạng thái, đánh dấu cảnh báo và cập nhật về Dashboard. Khi cần kiểm đếm, Dashboard gửi danh sách QR đã quét, hệ thống kiểm tra và đối chiếu với dữ liệu gốc để xác định chênh lệch, cảnh báo thiếu hoặc thừa, hoặc xác nhận tình trạng \emph{sẵn sàng xuất kho} nếu kết quả trùng khớp.

Trong suốt hành trình vận chuyển, hệ thống duy trì vòng giám sát điều kiện bảo quản. Thiết bị định kỳ gửi dữ liệu nhiệt độ, rung và mức pin. Hệ thống so sánh giá trị gửi lên với ngưỡng đặt trước; nếu có vi phạm, cảnh báo được tạo và gửi tới Dashboard đồng thời phát lệnh xử lý về Thiết bị. Nếu các giá trị vẫn trong ngưỡng an toàn, trạng thái ổn định được cập nhật liên tục để người vận hành theo dõi.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/sequence_quản lý hàng hóa.png}
  \caption{Sequence diagram: Quản lý hàng hoá}
  \label{fig:sd-hang-hoa}
\end{figure}

\subsection{Giám sát \& cập nhật trạng thái vận chuyển}

Chức năng giám sát và cập nhật trạng thái vận chuyển dựa trên luồng dữ liệu \emph{telemetry} do Thiết bị gửi định kỳ trong khoảng 5--15 giây. Dữ liệu bao gồm vị trí GPS, tốc độ, nhiệt độ, mức rung, dung lượng pin và chất lượng tín hiệu. Hệ thống xử lý dữ liệu theo cơ chế \emph{upsert}, đánh giá theo các luật giám sát như geofence, lệch tuyến, vi phạm nhiệt độ hoặc mất tín hiệu. Trên cơ sở đó, luồng xử lý được phân thành hai trường hợp: nếu phát hiện vi phạm, Hệ thống tạo thẻ cảnh báo (kèm vị trí hiện tại), hiển thị trên Dashboard và gửi lệnh xử lý xuống thiết bị như dừng an toàn, kiểm tra hoặc điều hướng lại tuyến; nếu không có vi phạm, hệ thống tiếp tục cập nhật tiến độ và ETA theo thời gian thực.

Trong trường hợp thiết bị mất kết nối, hệ thống phát hiện dựa trên thời gian im lặng vượt ngưỡng, đánh dấu thiết bị ở trạng thái \emph{offline} và thông báo vị trí cuối cùng cho Dashboard để người vận hành triển khai xác minh. Bên cạnh đó, hệ thống hỗ trợ cơ chế checkpoint/timeline, trong đó thiết bị gửi các mốc quan trọng như rời kho, đến điểm giao hoặc hoàn tất chuyến, giúp xây dựng dòng thời gian vận chuyển phục vụ truy vết và đánh giá hiệu suất.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{images/week/week_3/sequence_giám sát.png}
  \caption{Sequence diagram: Giám sát \& cập nhật trạng thái vận chuyển}
  \label{fig:sd-giam-sat}
\end{figure}