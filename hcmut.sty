\usepackage{a4wide,amssymb,epsfig,latexsym,multicol,array,hhline,fancyhdr}
\usepackage[utf8]{vietnam} 
\usepackage[T5]{fontenc} % Quan trọng để hiển thị tiếng Việt đúng font
\usepackage[vietnamese]{babel}
\usepackage{amssymb,gensymb,textcomp} \usepackage{array,multicol,multirow,siunitx,tabularx}
\usepackage{graphicx} 
\usepackage{float}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{mathptmx}[ptm]
\usepackage{adjustbox}
\usepackage{lipsum}
\usepackage{subcaption}
\usepackage{enumerate}
\usepackage{glossaries}
\makeglossaries
\usepackage{amsmath} 
\usepackage{pgffor}
\usepackage{float}
\usepackage{listings}
\usepackage{anyfontsize}
\usepackage{tikz}
\renewcommand\normalsize{%
   \@setfontsize\normalsize{14pt}{18pt} % chữ 14pt, khoảng cách dòng 16pt
}
\normalsize
\usepackage{diagbox}
\usepackage[table]{xcolor}
\usepackage{color}
\definecolor{light-gray}{gray}{0.95}
\newcommand{\code}[1]{\colorbox{light-gray}{\texttt{#1}}}
\usepackage{titlesec}

\titleformat{name=\chapter}{\filright\Large\scshape}{\thechapter}{.5em}{}

\captionsetup[figure]{labelfont={bf},textfont={it}}
\captionsetup[table]{labelfont={bf},textfont={it}}

\usepackage{amsfonts} 
\usepackage{caption}
\usepackage{subcaption}
\usepackage{amssymb} 
\usepackage{rotating}
\usepackage{tikz}
\usepackage{eso-pic}
\usepackage{changepage}
\usetikzlibrary{calc}
\usepackage[colorlinks = true,
            linkcolor = black,
            urlcolor  = blue,
            citecolor = blue,
            anchorcolor = blue]{hyperref}
\usepackage{enumitem}
\usepackage[left=3cm,right=2.5cm,top=2.5cm,bottom=3.5cm]{geometry} 
\usepackage{scrextend}
\usepackage{algorithm2e}
\usepackage{etoolbox}
\usepackage{ragged2e}
\usepackage{minted}
\usepackage{lastpage}

\raggedbottom
\usepackage{fancyhdr}
\fancyhf{} 
\usepackage{lipsum} % demo text
\setlength{\footskip}{1.5cm}

% --------- Kiểu mặc định: chỉ số trang ở dưới phải ----------
\fancypagestyle{plain}{%
  \fancyhf{}
  \fancyfoot[R]{\large\thepage} % số trang ở footer phải, to hơn
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% --------- Kiểu cho các trang có header ----------
\fancypagestyle{myheader}{%
  \fancyhf{}
  % header khác nhau cho trang chẵn/lẻ
  \fancyhead[LE]{\large\thepage}      % trang chẵn: số trang trái header
  \fancyhead[RO]{\large\thepage}      % trang lẻ: số trang phải header
  \fancyhead[RE]{\large\leftmark}     % chẵn: tên chương
  \fancyhead[LO]{\large\rightmark}    % lẻ: tên section
  \renewcommand{\headrulewidth}{0.4pt}
}

% --- bỏ chữ CHƯƠNG trong \leftmark
\renewcommand{\chaptermark}[1]{%
  \markboth{\MakeUppercase{\thechapter.\ #1}}{}}

% áp dụng cho toàn bộ document
\pagestyle{myheader}

% đảm bảo các trang đầu chương (plain) dùng style riêng
\makeatletter
\renewcommand{\chapter}{%
  \if@openright\cleardoublepage\else\clearpage\fi
  \thispagestyle{plain}% trang đầu chương dùng plain
  \global\@topnum\z@
  \secdef\@chapter\@schapter}
\makeatother

\usepackage{tikz,tkz-tab}
\usepackage{pifont}
\definecolor{lightgray}{gray}{0.9}
\definecolor{headergray}{gray}{0.7}
\usetikzlibrary{shapes.geometric, arrows}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{amsthm}
\usepackage{xurl}
\usepackage{commath}
\usepackage{framed}
\usepackage{commath}
\usepackage{framed}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{indentfirst}
\usepackage{tocloft}% to configure the ToC <<<<<
\renewcommand{\cfttoctitlefont}{\hfill\Huge\bfseries} % đẩy sang phải
\renewcommand{\cftloftitlefont}{\hfill\Huge\bfseries}
\renewcommand{\cftlottitlefont}{\hfill\Huge\bfseries}

% Định dạng chương số + tên đều căn phải
\titleformat{\chapter}[display]
  {\bfseries\Huge}   % Font to, đậm
  {\hfill\fontsize{100}{100}\selectfont\thechapter} % số chương to, căn phải
  {0pt}
  {\hfill\MakeUppercase}        % tên chương cũng căn phải, in hoa

% --- FIX FONT SIZE CHO SECTION/SUBSECTION ---
\titleformat{\section}
  {\bfseries\Large}          % Section lớn hơn
  {\thesection}{0.8em}{}

\titleformat{\subsection}
  {\bfseries\itshape\normalsize}     % Subsection = normalsize hoặc đổi sang \large tuỳ ý
  {\thesubsection}{0.6em}{}

\titleformat{\subsubsection}
  {\itshape\normalsize}     % Subsubsection nhỏ hơn subsection
  {\thesubsubsection}{0.4em}{}


\usepackage{tikzpagenodes}
\usepackage{everypage}
\usepackage{etoolbox}

% --- Thông số tab ---
\newlength{\tabwidth}\setlength{\tabwidth}{3cm}
\newlength{\tabheight}\setlength{\tabheight}{1cm}
\newlength{\tabout}\setlength{\tabout}{1.5cm}
\newlength{\tabstep}\setlength{\tabstep}{2cm}

% --- Số chapter cố định ---
\newcommand{\MaxChapters}{6}

% --- Cờ nhận biết trang trắng ---
\newif\ifblankpage
\blankpagefalse

\makeatletter
\renewcommand{\cleardoublepage}{%
  \clearpage
  \ifodd\c@page\else
    \hbox{}%
    \thispagestyle{empty}%
    \global\blankpagetrue
    \newpage
    \global\blankpagefalse
  \fi
}
\makeatother

% --- Cờ chapter chính (1~6) ---
\newif\ifmainchapter
\mainchapterfalse

% --- Patch \chapter (chính) ---
\usepackage{xpatch}
\xpretocmd{\chapter}{%
  \ifnum\value{chapter}<\numexpr\MaxChapters+1\relax
    \global\mainchaptertrue
  \else
    \global\mainchapterfalse
  \fi
}{}{}

% --- Patch \chapter* (phụ: appendix/glossary/ref) ---
\xpretocmd{\chapter*}{%
  \global\mainchapterfalse
}{}{}

% --- Vẽ tab theo chapter chính ---
\newcommand{\ChapterBox}{%
  \ifnum\value{chapter}>0
    \begin{tikzpicture}[remember picture,overlay]
      % Tính vị trí theo số chapter
      \pgfmathsetlengthmacro{\yshift}{-\value{chapter} * \tabstep}
      \ifodd\value{page}
        \node[
          anchor=west,
          rectangle,
          fill=black,
          text=white,
          minimum width=\tabwidth,
          minimum height=\tabheight,
          rounded corners=3pt,
          inner xsep=6pt,
          inner ysep=2pt,
          text width=\tabwidth,
          align=right
        ] 
        at ([xshift=-\tabout,yshift=\yshift]current page.west|-current page text area.north)
        {\bfseries\fontsize{18}{20}\selectfont\thechapter};
      \else
        \node[
          anchor=east,
          rectangle,
          fill=black,
          text=white,
          minimum width=\tabwidth,
          minimum height=\tabheight,
          rounded corners=3pt,
          inner xsep=6pt,
          inner ysep=2pt,
          text width=\tabwidth,
          align=left
        ] 
        at ([xshift=\tabout,yshift=\yshift]current page.east|-current page text area.north)
        {\bfseries\fontsize{18}{20}\selectfont\thechapter};
      \fi
    \end{tikzpicture}%
  \fi
}

% --- Hook vẽ tab mỗi trang ---
\newcommand{\MaybeChapterBox}{%
  \ifblankpage\relax
  \else
    \ChapterBox
  \fi
}

\AddEverypageHook{\MaybeChapterBox}
\titlespacing*{\section}{0pt}{0.8em}{0.8em}
\titlespacing*{\subsection}{0pt}{0.5em}{0.5em}

%\renewcommand{\cftaftertoctitle}{\hfill}   
\usepackage{circuitikz}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning, shapes.geometric, shapes.multipart, circuits.logic.US}
\makeatletter
\newcommand{\mylabel}[2]{#2\def\@currentlabel{#2}\label{#1}}
\makeatother

\hypersetup{urlcolor=blue,linkcolor=black,citecolor=black,colorlinks=true} 
%\usepackage{pstcol} 								% PSTricks with the standard color package

\newtheorem{theorem}{{\bf Theorem}}
\newtheorem{property}{{\bf Property}}
\newtheorem{proposition}{{\bf Proposition}}
\newtheorem{corollary}[proposition]{{\bf Corollary}}
\newtheorem{lemma}[proposition]{{\bf Lemma}}

\titleformat{\paragraph}
{\normalfont\normalsize\itshape}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\renewcommand{\figureautorefname}{Hình}
\renewcommand{\tableautorefname}{Bảng}
\renewcommand{\equationautorefname}{Phương trình}
\renewcommand{\sectionautorefname}{Mục}
\renewcommand{\subsectionautorefname}{Phần}
\renewcommand{\subsubsectionautorefname}{Phần}

\AtBeginDocument{\renewcommand*\contentsname{Mục lục}}
\AtBeginDocument{\renewcommand*\refname{Tài liệu tham khảo}}


%%%
\setlength{\cftsecnumwidth}{4.5ex}
\setlength{\cftsubsecindent}{6.5ex}
\setlength{\cftsubsubsecindent}{10.5ex}   % indent của subsubsection
\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{3}
\makeatletter
\newcounter{subsubsubsection}[subsubsection]
\renewcommand\thesubsubsubsection{\thesubsubsection.\@alph\c@subsubsubsection}

% Định nghĩa heading
\newcommand\subsubsubsection{\@startsection{subsubsubsection}{4}{\z@}%
  {-3.25ex\@plus -1ex \@minus -.2ex}%
  {1.5ex\@plus .2ex}%
  {\normalfont\normalsize\bfseries}}

% --- FIX: khai báo với tocloft ---
\providecommand{\toclevel@subsubsubsection}{4}
\providecommand{\l@subsubsubsection}{}

% sửa indent
\renewcommand*\l@subsubsubsection{\@dottedtocline{4}{9em}{3em}}
\makeatother

% The package belong to this particular document.
\usepackage{xcolor}
\usepackage{listings}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}



% GLOSSARY
\newglossaryentry{iot}{
    name=IoT,
    description={Internet of Things – Mạng lưới các thiết bị kết nối Internet}
}

\newglossaryentry{mqtt}{
    name=MQTT,
    description={Message Queuing Telemetry Transport – Giao thức nhẹ cho IoT}
}

\newglossaryentry{coap}{
    name=CoAP,
    description={Constrained Application Protocol – Giao thức cho thiết bị hạn chế tài nguyên}
}

\newglossaryentry{ble}{
    name=BLE,
    description={Bluetooth Low Energy – Giao thức Bluetooth tiết kiệm năng lượng cho IoT}
}

\newglossaryentry{zigbee}{
    name=Zigbee,
    description={Giao thức mạng không dây cho các thiết bị IoT}
}

\newglossaryentry{lora}{
    name=LoRa,
    description={Long Range – Giao thức truyền dữ liệu khoảng cách xa cho IoT}
}

\newglossaryentry{edge}{
    name=Edge Computing,
    description={Xử lý dữ liệu tại gần nguồn thu thập để giảm tải lên cloud}
}

\newglossaryentry{cloud}{
    name=Cloud Computing,
    description={Tính toán đám mây – Lưu trữ và xử lý dữ liệu IoT trên server từ xa}
}